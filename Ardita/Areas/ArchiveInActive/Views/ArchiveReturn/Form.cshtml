@using Ardita.Extensions;
@using Ardita.Models.ViewModels;
@using Ardita.Models.DbModels;
@model Ardita.Models.DbModels.TrxArchiveRent;
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    Layout = GlobalConst.ViewStart;
    FormModel form = Html.Form();
    form.isInput = false;
}

<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>Media Storage In Active</h2>
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="@Url.Action(GlobalConst.Index, GlobalConst.Home, new {Area = GlobalConst.General})"><i class="fa fa-home"></i></a>
            </li>
            <li class="breadcrumb-item">
                Archive Active
            </li>
            <li class="breadcrumb-item">
                <a href="@Url.Action(GlobalConst.Index, GlobalConst.ArchiveRent, new {Area = GlobalConst.ArchiveInActive})">Archive Rent</a>
            </li>
            <li class="active breadcrumb-item">
                <strong>@form.LastBreadcrumb</strong>
            </li>
        </ol>
    </div>
</div>

<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>Page</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="dropdown-toggle" data-toggle="dropdown" href="form_basic.html#">
                            <i class="fa fa-wrench"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-user">
                            <li>
                                <a href="form_basic.html#" class="dropdown-item">Config option 1</a>
                            </li>
                            <li>
                                <a href="form_basic.html#" class="dropdown-item">Config option 2</a>
                            </li>
                        </ul>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="form-group">
                                        <label>Scan QR</label>
                                        <input type="text" class="form-control" onchange="getRent($(this))" value="@(Model.TrxArchiveRentId == Guid.Empty ? ViewBag.QR : Model.TrxArchiveRentId)" />
                                    </div>
                                </div>
                            </div>
                            <form id="frmRetrieval" method="post" enctype="multipart/form-data" asp-controller="@GlobalConst.ArchiveReturn" asp-action="@GlobalConst.UpdateReturn" asp-area="@GlobalConst.ArchiveInActive">
                                <input type="hidden" asp-for="TrxArchiveRentId" />
                                <div class="row">
                                    <div class="col-sm-6 b-r">
                                        <div class="form-group divNameText">
                                            <label>Nama</label>
                                            <input type="text" class="form-control @Html.Raw(form.isInput ? GlobalConst.Required : GlobalConst.Disabled)" name="borrowerName" id="borrowerName" @Html.Raw(Model.TrxRentHistories.Count > 0 ? $"value='{Model.TrxRentHistories.FirstOrDefault().Borrower.BorrowerName}'" : "") />
                                        </div>
                                        <div class="form-group">
                                            <label>Company</label>
                                            <input type="text" class="form-control @Html.Raw(form.isInput ? GlobalConst.Required : GlobalConst.Disabled)" name="borrowerCompany" id="borrowerCompany" @Html.Raw(Model.TrxRentHistories.Count > 0 ? $"value='{Model.TrxRentHistories.FirstOrDefault().Borrower.BorrowerCompany}'" : "") />
                                        </div>
                                        <div class="form-group">
                                            <label>Unit Kerja</label>
                                            <input type="text" class="form-control @Html.Raw(form.isInput ? GlobalConst.Required : GlobalConst.Disabled)" name="borrowerArchiveUnit" id="borrowerArchiveUnit" @Html.Raw(Model.TrxRentHistories.Count > 0 ? $"value='{Model.TrxRentHistories.FirstOrDefault().Borrower.BorrowerArchiveUnit}'" : "") />
                                        </div>
                                        <div class="form-group">
                                            <label>Jabatan</label>
                                            <input type="text" class="form-control @Html.Raw(form.isInput ? GlobalConst.Required : GlobalConst.Disabled)" name="borrowerPosition" id="borrowerPosition" @Html.Raw(Model.TrxRentHistories.Count > 0 ? $"value='{Model.TrxRentHistories.FirstOrDefault().Borrower.BorrowerPosition}'" : "") />
                                        </div>
                                        <div class="form-group">

                                            <label>Tanggal Kembali</label>
                                            <input type="date" class="form-control @Html.Raw(form.isInput ? GlobalConst.Required : GlobalConst.Disabled)" name="borrowerEmail" value="@(Model.ApprovalReturnDate == null ? "" : ((DateTime)Model.ApprovalReturnDate).ToString("yyyy-MM-dd"))" />

                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <label>No. Identitas (KTP, SIM)</label>
                                            <input type="text" class="form-control @Html.Raw(form.isInput ? GlobalConst.Required : GlobalConst.Disabled)" name="borrowerIdentityId" id="borrowerIdentityId" @Html.Raw(Model.TrxRentHistories.Count > 0 ? $"value='{Model.TrxRentHistories.FirstOrDefault().Borrower.BorrowerIdentityNumber}'" : "") />
                                        </div>
                                        <div class="form-group">

                                            <label>No. Handphone</label>
                                            <input type="text" class="form-control @Html.Raw(form.isInput ? GlobalConst.Required : GlobalConst.Disabled)" name="borrowerPhone" id="borrowerPhone" @Html.Raw(Model.TrxRentHistories.Count > 0 ? $"value='{Model.TrxRentHistories.FirstOrDefault().Borrower.BorrowerPhone}'" : "") />

                                        </div>
                                        <div class="form-group">

                                            <label>Email</label>
                                            <input type="text" class="form-control @Html.Raw(form.isInput ? GlobalConst.Required : GlobalConst.Disabled)" name="borrowerEmail" id="borrowerEmail" @Html.Raw(Model.TrxRentHistories.Count > 0 ? $"value='{Model.TrxRentHistories.FirstOrDefault().Borrower.BorrowerEmail}'" : "") />

                                        </div>
                                        <div class="form-group">

                                            <label>Tanggal Request</label>
                                            <input type="date" class="form-control @Html.Raw(form.isInput ? GlobalConst.Required : GlobalConst.Disabled)" name="borrowerEmail" value="@(Model.ApprovalDate == null ? "" : ((DateTime)Model.ApprovalDate).ToString("yyyy-MM-dd"))" />

                                        </div>
                                        <div class="form-group">
                                            <label>Alasan Peminjaman</label>
                                            <textarea class="form-control @Html.Raw(form.isInput ? GlobalConst.Required : GlobalConst.Disabled)">@(Model.Description)</textarea>
                                        </div>

                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="tabs-container">
                                            <ul class="nav nav-tabs" role="tablist">
                                                <li><a class="nav-link active" data-toggle="tab" href="#tab-1" id="nav-1">Validasi</a></li>
                                                <li><a class="nav-link" data-toggle="tab" href="#tab-2" id="nav-2">Tervalidasi</a></li>
                                            </ul>
                                            <div class="tab-content">
                                                <div role="tabpanel" id="tab-1" class="tab-pane active">
                                                    <div class="panel-body">
                                                        <div class="row">
                                                            <div class="col-sm-12">
                                                                <table id="tblValidate" class="table table-striped table-hover dataTables-example" style="width:100%">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>Validasi</th>
                                                                            <th>Kode Media Penyimpanan</th>
                                                                            <th>Urutan</th>
                                                                            <th>Jenis Penyimpanan</th>
                                                                            <th>Klasifikasi</th>
                                                                            <th>Unit Kearsipan</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody id="data-cart">
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div role="tabpanel" id="tab-2" class="tab-pane">
                                                    <div class="panel-body">
                                                        <table id="tblValidated" class="table table-striped table-hover dataTables-example" style="width:100%">
                                                            <thead>
                                                                <tr>
                                                                    <th>Kode Media Penyimpanan</th>
                                                                    <th>Urutan</th>
                                                                    <th>Jenis Penyimpanan</th>
                                                                    <th>Klasifikasi</th>
                                                                    <th>Unit Kearsipan</th>
                                                                    <th>Status</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="data-cart">
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-12 pt-3">
                                        <div class="form-group">
                                            <a href="@Url.Action(GlobalConst.Index, form.CurrentController, new { Area = form.CurrentArea })"
                                               class="btn btn-sm btn-default float-right m-t-n-xs">
                                                @Html.Raw(form.BackText)
                                            </a>
                                            <button class="btn btn-sm btn-success float-right m-t-n-xs mr-1" id="btnSubmit" style="display:none"
                                                    type="submit" id="btn-submit" name="@GlobalConst.Submit" value="@GlobalConst.Submit">
                                                @Html.Raw(form.SubmitText)
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--Modal-->
        <div class="modal inmodal" id="frmRequest" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-lg" style="width:80%;max-width:unset !important">
                <div class="modal-content animated fadeIn">

                    @Html.AntiForgeryToken();
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title">Validasi Pengambilan</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="row">
                                    <div class="col-sm-7">
                                        <div class="form-group">
                                            <label>Scan QR BOX</label>
                                            <input type="hidden" id="txtCodeBox" />
                                            <div style="display:flex">
                                                <input type="text" class="form-control" onchange="checkCodeBox($(this))" id="txtCodeBoxValid" />
                                                <i id="validBox" class="fa fa-check-circle" style="color:green;font-size:16px;padding:7px;display:none"></i>
                                                <i id="inValidBox" class="fa fa-times-circle" style="color:red;font-size:16px;padding:7px;display:none"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <label>Unit Kearsipan</label>
                                            <input type="text" placeholder="" id="txtArchiveUnit" class="form-control" disabled>
                                        </div>
                                        <div class="form-group">
                                            <label>Lantai</label>
                                            <input type="text" placeholder="" id="txtFloor" class="form-control" disabled>
                                        </div>
                                        <div class="form-group">
                                            <label>Ruangan</label>
                                            <input type="text" placeholder="" id="txtRoom" class="form-control" disabled>
                                        </div>

                                    </div>
                                    <div class="col-sm-6">

                                        <div class="form-group">
                                            <label>Rak</label>
                                            <input type="text" placeholder="" id="txtRack" class="form-control" disabled>
                                        </div>
                                        <div class="form-group">
                                            <label>Tingkat</label>
                                            <input type="text" placeholder="" id="txtLevel" class="form-control" disabled>
                                        </div>
                                        <div class="form-group">
                                            <label>Baris</label>
                                            <input type="text" placeholder="" id="txtRow" class="form-control" disabled>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <div class="row">
                            <table id="tblToValidate" class="table table-striped table-hover dataTables-example" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>Kode Media Penyimpanan</th>
                                        <th>Urutan</th>
                                        <th>Jenis Penyimpanan</th>
                                        <th>Klasifikasi</th>
                                        <th>Judul Arsip</th>
                                        <th>Pencipta</th>
                                        <th>Validasi</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="btnValid" type="button" class="btn btn-sm btn-success" style="display:none" onclick="validated()"><i class="fa fa-check"></i><span class="bold"> Valid</span></button>
                        <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                    </div>


                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script type="text/javascript">
        var tableValidate, tableValidated;
        var dataRow = null;
        $(document).ready(function () {
            initDataTable();

            if ('@ViewBag.Notif' != '') {
                swal({ title: "Gagal!", text: 'Tidak Ditemukan!', type: "error" });
            }
        });

        function getRent(e) {
            if (e.val() != '') {
                $('#wrapper').toggleClass('sk-loading');
                window.location.href = '@Url.Action(GlobalConst.ArchiveReturn, GlobalConst.ArchiveReturn, new { Area = GlobalConst.ArchiveInActive, Id = -1})'.replace('-1', e.val());
            }
        }

        function validateInputType() {
            var inputType = $("input[name='borrowerType']:checked").val();
            if (inputType == 'Baru') {
                $('#borrowerName').prop('required', true);
                $('#borrowerNameSelect').prop('required', false);
            } else {
                $('#borrowerName').prop('required', false);
                $('#borrowerNameSelect').prop('required', true);
            }
        }

        function initDataTable() {
            initTableValidate();
            initTableValidated();
        }

        function initTableValidate() {
            $.ajax({
                'url': '@Url.Action(GlobalConst.GetDataRentBox, GlobalConst.ArchiveReturn, new { Area = GlobalConst.ArchiveInActive })',
                'method': "GET",
                'contentType': 'application/json',
                'data': { "Id": '@Model.TrxArchiveRentId' }
            }).done(function (data) {

                tableValidate = $('#tblValidate').DataTable({
                    "data": data,
                    "destroy": true,
                    "searching": false,
                    "paging": false,
                    "info": false,
                    "columns": [
                        {
                            "data": "mediaStorageInActiveId", "orderable": false, "searchable": false, "render": function (data, type, row, meta) {
                                return `<button type="button" class="btn btn-sm btn-primary archiveNotValidate" onclick="validate($(this))" value="${data + '#' + row.sort}"><i class="fa fa-check" style="color:white;font-size:14px;"></i> Validasi</button>`;
                            }
                        },
                        { "data": "mediaStorageInActiveCode" },
                        { "data": "sort" },
                        { "data": "subTypeStorageName" },
                        { "data": "classificationName" },
                        { "data": "archiveUnitName" }
                    ]
                });
            })
        }
        function initTableValidated() {
            tableValidated = $('#tblValidated').DataTable({
                "destroy": true,
                "searching": false,
                "paging": false,
                "info": false,
                "columns": [
                    { "data": "mediaStorageInActiveCode" },
                    { "data": "sort" },
                    { "data": "subTypeStorageName" },
                    { "data": "classificationName" },
                    { "data": "archiveUnitName" },
                    {
                        "data": "mediaStorageInActiveId", "orderable": false, "searchable": false, "render": function (data, type, row, meta) {
                            return `<span class="badge badge-pill badge-primary"><i class="fa fa-check" style="color:white;font-size:14px;"></i> Tervalidasi</button>`;
                        }
                    },
                ]
            });
        }

        function initButtonRequest(data) {
            if (data > 0) {
                $('#btnRequestPinjamMdl').show();
            } else {
                $('#btnRequestPinjamMdl').hide();
            }
        }

        function checkCodeBox(e) {
            if (e.val() == $('#txtCodeBox').val()) {
                $('.checkArchive').show();
                $('#validBox').show();
                $('#inValidBox').hide();
            } else {
                $('#validBox').hide();
                $('#inValidBox').show();
                $('#btnValid').hide();

                $('.checkArchive').each(function () {
                    $(this).prop('checked', false);
                    $(this).hide();
                });
            }
        }

        function validated() {
            if (dataRow != null) {
                var data = JSON.parse(JSON.stringify(dataRow.data()));

                dataRow.remove().draw();

                tableValidated.row.add(data).draw();
            }

            dataRow = null;

            $('#nav-1').removeClass('active');
            $('#nav-2').addClass('active');
            $('#tab-1').removeClass('active');
            $('#tab-2').addClass('active');

            $('#frmRequest').modal('hide');

            if ($('.archiveNotValidate').length == 0) {
                $('#btnSubmit').show();
            }
        }

        function validate(e) {
            $('#wrapper').toggleClass('sk-loading');

            var tr = e.parent('td').parent('tr');
            var row = tableValidate.row(tr);

            var dataBox = e.val().split('#');

            dataRow = row;

            initTable(dataBox[0], dataBox[1])
        }

        function validateArchive() {
            var isValidAllArchive = true;
            $('.checkArchive').each(function () {
                if ($(this).prop('checked') == false) {
                    isValidAllArchive = false
                }
            });

            if (isValidAllArchive) {
                $('#btnValid').show();
            } else {
                $('#btnValid').hide();
            }
        }

        function initTable(id, sort) {
            $.ajax({
                'url': '@Url.Action(GlobalConst.GetDataRentBoxDetail, GlobalConst.ArchiveReturn, new { Area = GlobalConst.ArchiveInActive })',
                'method': "GET",
                'contentType': 'application/json',
                'data': { "Id": id, "Sort": sort }
            }).done(function (data) {

                $('#txtArchiveUnit').val(data.main.row.level.rack.room.floor.archiveUnit.archiveUnitName);
                $('#txtFloor').val(data.main.row.level.rack.room.floor.floorName);
                $('#txtRoom').val(data.main.row.level.rack.room.roomName);
                $('#txtRack').val(data.main.row.level.rack.rackName);
                $('#txtLevel').val(data.main.row.level.levelName);
                $('#txtRow').val(data.main.row.rowName);

                $('#tblToValidate').DataTable({
                    "data": data.detail,
                    "destroy": true,
                    "searching": false,
                    "paging": false,
                    "info": false,
                    "fixedColumns": true,
                    "columnDefs": [
                        {
                            targets: [6],
                            className: `text-center`
                        }
                    ],
                    "columns": [
                        { "data": "mediaStorageInActiveCode" },
                        { "data": "sort" },
                        { "data": "storageName" },
                        { "data": "classificationName" },
                        { "data": "titleArchive" },
                        { "data": "creatorName" },
                        {
                            "data": "mediaStorageInActiveId", "orderable": false, "searchable": false, "render": function (data, type, row, meta) {
                                return `<input type="checkbox" onchange="validateArchive()" class="checkArchive" />`;
                            }
                        },
                    ]
                });

                $('#txtCodeBox').val(data.main.mediaStorageInActiveCode);
                $('#txtCodeBoxValid').val('');
                $('.checkArchive').hide();
                $('#btnValid').hide();
                $('#validBox').hide();
                $('#inValidBox').hide();
                $('#frmRequest').modal('show');

                $('#wrapper').toggleClass('sk-loading');
            })
        }
    </script>
}